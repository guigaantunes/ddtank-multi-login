name: Build and Release

on:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  build-and-upload:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Sciter SDK
        uses: actions/cache@v4
        with:
          path: .sciter-sdk
          key: sciter-js-sdk-v1-${{ hashFiles('build.rs') }}

      - name: Setup Sciter SDK
        shell: pwsh
        run: |
          $sdkPath = ".sciter-sdk\sciter-js-sdk-main"
          $legacyPath = "C:\sciter-js-sdk-main"

          if (-not (Test-Path "$sdkPath\bin\windows\packfolder.exe")) {
            Write-Host "Downloading Sciter SDK..." -ForegroundColor Yellow
            New-Item -ItemType Directory -Path ".sciter-sdk" -Force | Out-Null
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
            Invoke-WebRequest -Uri "https://github.com/c-smile/sciter-js-sdk/archive/refs/heads/main.zip" -OutFile ".sciter-sdk\sdk.zip"
            Expand-Archive -Path ".sciter-sdk\sdk.zip" -DestinationPath ".sciter-sdk" -Force
            Remove-Item ".sciter-sdk\sdk.zip" -ErrorAction SilentlyContinue
            Write-Host "Sciter SDK downloaded successfully" -ForegroundColor Green
          } else {
            Write-Host "Sciter SDK found in cache" -ForegroundColor Green
          }

          # Create legacy path junction for backward compatibility with older build.rs
          if (-not (Test-Path $legacyPath)) {
            $resolvedSdk = (Resolve-Path $sdkPath).Path
            New-Item -ItemType Junction -Path $legacyPath -Target $resolvedSdk | Out-Null
            Write-Host "Created legacy junction: $legacyPath -> $resolvedSdk" -ForegroundColor Green
          }

      - name: Get version from Cargo.toml
        id: get_version
        shell: pwsh
        run: |
          $cargoToml = Get-Content ".\Cargo.toml" -Raw
          if ($cargoToml -match 'version\s*=\s*"([^"]+)"') {
            echo "version=$($matches[1])" >> $env:GITHUB_OUTPUT
            Write-Host "Versao detectada: $($matches[1])" -ForegroundColor Green
          } else {
            Write-Error "Nao foi possivel ler a versao do Cargo.toml"
            exit 1
          }

      - name: Build release
        shell: pwsh
        run: |
          Write-Host "Compilando projeto em modo release..." -ForegroundColor Yellow
          cargo build --release
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Erro na compilacao!"
            exit 1
          }

      - name: Package release
        if: github.event_name == 'release'
        id: package
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $releaseName = "release-$version"
          $releaseDir = ".\$releaseName"
          $zipFile = "$releaseName.zip"

          if (Test-Path $releaseDir) { Remove-Item $releaseDir -Recurse -Force }
          if (Test-Path $zipFile)    { Remove-Item $zipFile -Force }

          New-Item -ItemType Directory -Path $releaseDir | Out-Null

          $filesToCopy = @(
            @{Source = ".\target\release\ddtank-rs.exe"; Dest = "$releaseDir\ddtank-rs.exe"; Required = $true},
            @{Source = ".\target\release\sciter.dll";    Dest = "$releaseDir\sciter.dll";    Required = $true},
            @{Source = ".\target\release\ui.rc";         Dest = "$releaseDir\ui.rc";         Required = $false},
            @{Source = ".\target\release\reguinha.exe";  Dest = "$releaseDir\reguinha.exe";  Required = $false},
            @{Source = ".\target\release\userdata.redb"; Dest = "$releaseDir\userdata.redb"; Required = $false}
          )

          foreach ($file in $filesToCopy) {
            if (Test-Path $file.Source) {
              Copy-Item $file.Source $file.Dest
              Write-Host "  [OK] $($file.Source)" -ForegroundColor Green
            } elseif ($file.Required) {
              Write-Error "  [ERRO] $($file.Source) (OBRIGATORIO - NAO ENCONTRADO)"
              exit 1
            } else {
              Write-Host "  [AVISO] $($file.Source) (opcional - nao encontrado)" -ForegroundColor DarkYellow
            }
          }

          if (Test-Path ".\target\release\scripts") {
            Copy-Item ".\target\release\scripts" -Destination "$releaseDir\scripts" -Recurse
            Write-Host "  [OK] scripts\" -ForegroundColor Green
          }

          Compress-Archive -Path $releaseDir -DestinationPath $zipFile -CompressionLevel Optimal
          Write-Host "Arquivo ZIP criado: $zipFile" -ForegroundColor Green
      
      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./release-${{ steps.get_version.outputs.version }}.zip
          asset_name: release-${{ steps.get_version.outputs.version }}.zip
          asset_content_type: application/zip
